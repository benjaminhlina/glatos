context("Check residence_index")

# Actual result
# get path to example detection file
bsd_file <- system.file("extdata",
  "blue_shark_detections.csv",
  package = "glatos"
)

data <- read_otn_detections(bsd_file)

cdata <- glatos::detection_events(data, location_col = "station")
rik_data <- glatos::residence_index(cdata,
  calculation_method = "kessel",
  group_col = NULL
)
rit_data <- glatos::residence_index(cdata,
  calculation_method = "timedelta",
  group_col = NULL
)
riawo_data <- glatos::residence_index(cdata,
  calculation_method = "aggregate_with_overlap",
  group_col = NULL
)
riano_data <- glatos::residence_index(cdata,
  calculation_method = "aggregate_no_overlap",
  group_col = NULL
)

# define expected objects

blueshark_ri_kessel_data <-
  structure(list(
    days_detected = c(
      9, 9, 7, 8, 9, 3, 2, 10, 10,
      9, 7, 4, 2, 1, 2, 1, 2, 2, 2, 2, 10, 5, 3, 2, 3, 3, 3, 2, 2,
      4, 2, 2, 2, 2, 2, 1, 2, 2, 1, 1
    ), residency_index = c(
      0.818181818181818,
      0.818181818181818, 0.636363636363636, 0.727272727272727, 0.818181818181818,
      0.272727272727273, 0.181818181818182, 0.909090909090909, 0.909090909090909,
      0.818181818181818, 0.636363636363636, 0.363636363636364, 0.181818181818182,
      0.0909090909090909, 0.181818181818182, 0.0909090909090909, 0.181818181818182,
      0.181818181818182, 0.181818181818182, 0.181818181818182, 0.909090909090909,
      0.454545454545455, 0.272727272727273, 0.181818181818182, 0.272727272727273,
      0.272727272727273, 0.272727272727273, 0.181818181818182, 0.181818181818182,
      0.363636363636364, 0.181818181818182, 0.181818181818182, 0.181818181818182,
      0.181818181818182, 0.181818181818182, 0.0909090909090909, 0.181818181818182,
      0.181818181818182, 0.0909090909090909, 0.0909090909090909
    ),
    location = c(
      "HFX034",
      "HFX035", "HFX047", "HFX046", "HFX043", "HFX053", "HFX054", "HFX041",
      "HFX040", "HFX038(lost/found)", "HFX033", "HFX052", "HFX051",
      "HFX062", "HFX063", "HFX060", "HFX059(lost/found)", "HFX057",
      "HFX058", "HFX056", "HFX039", "HFX048", "HFX049", "HFX055", "HFX032",
      "HFX031", "HFX030", "HFX029", "HFX028", "HFX024", "HFX023", "HFX050",
      "HFX027", "HFX025", "HFX026", "HFX021", "HFX017", "HFX016", "HFX013",
      "HFX014"
    ), mean_latitude = c(
      44.28729, 44.28173, 44.2133, 44.21905,
      44.23626, 44.17948, 44.17387, 44.24714, 44.25293, 43.4, 44.29311,
      44.18508, 44.19071, 44.12893, 44.12289, 44.13981, 44.1, 44.15686,
      44.15139, 44.16265, 44.25865, 44.20696, 44.20203, 44.16814, 44.29906,
      44.30479, 44.3106, 44.31668, 44.32302, 44.34509, 44.35121, 44.19641,
      44.32771, 44.33924, 44.33408, 44.36267, 44.3855, 44.39144, 44.40863,
      44.403
    ), mean_longitude = c(
      -63.31992, -63.3131, -63.23715, -63.24336,
      -63.26195, -63.20007, -63.19376, -63.27502, -63.28102, -65.6,
      -63.32598, -63.20632, -63.21268, -63.14374, -63.13765, -63.15623,
      -63.3, -63.17499, -63.16853, -63.18116, -63.28784, -63.23135,
      -63.2246, -63.18762, -63.33237, -63.33867, -63.34534, -63.35154,
      -63.36093, -63.38422, -63.39103, -63.21911, -63.36478, -63.37781,
      -63.3713, -63.40261, -63.42997, -63.43603, -63.45589, -63.44875
    )
  ), class = "data.frame", row.names = c(NA, -40L))

blueshark_ri_td_data <-
  structure(list(days_detected = c(
    0, 0.0119907407407407, 0.229189814814815,
    0.236770833333333, 0, 0.0171296296296296, 5.30424768518519, 4.31056712962963,
    4.33679398148148, 0.132662037037037, 0.374652777777778, 0.417314814814815,
    1.61196759259259, 2.45387731481481, 2.45918981481482, 7.69414351851852,
    9.8066087962963, 9.83518518518519, 10.2265046296296, 9.73806712962963,
    9.64605324074074, 10.383599537037, 10.0781134259259, 8.96850694444444,
    8.33770833333333, 7.58980324074074, 7.56431712962963, 2.16046296296296,
    0.714791666666667, 7.77197916666667, 7.0502662037037, 7.26163194444444,
    7.20189814814815, 7.28798611111111, 7.31960648148148, 7.31309027777778,
    7.33803240740741, 0.0037037037037037, 0.029212962962963, 1.98929398148148
  ), total_days = c(
    10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556, 10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556, 10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556, 10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556, 10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556, 10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556, 10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556, 10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556, 10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556, 10.6743055555556, 10.6743055555556, 10.6743055555556,
    10.6743055555556
  ), residency_index = c(
    0, 0.0011233274781515,
    0.0214711686509227, 0.0221813805217618, 0, 0.00160475354021642,
    0.496917355192679, 0.40382646975907, 0.406283477544293, 0.0124281655932167,
    0.0350985622275714, 0.0390952659770564, 0.151013813891961, 0.229886366100666,
    0.230384056556719, 0.72080974996205, 0.91871164313751, 0.921388762388047,
    0.958048706438531, 0.912290460390779, 0.903670331576779, 0.972765814412422,
    0.94414698674994, 0.840195823303624, 0.781100774185154, 0.711034849174853,
    0.708647236137315, 0.202398455966864, 0.0669637629301932, 0.728101619933641,
    0.660489449829766, 0.680290807364518, 0.674694771539479, 0.682759742371999,
    0.685722030663804, 0.685111573742762, 0.687448225012469, 0.000346973738425173,
    0.00273675536182855, 0.186362847786958
  ), location = c(
    "HFX013",
    "HFX014", "HFX016", "HFX017", "HFX021", "HFX023", "HFX024", "HFX025",
    "HFX026", "HFX027", "HFX028", "HFX029", "HFX030", "HFX031", "HFX032",
    "HFX033", "HFX034", "HFX035", "HFX038(lost/found)", "HFX039",
    "HFX040", "HFX041", "HFX043", "HFX046", "HFX047", "HFX048", "HFX049",
    "HFX050", "HFX051", "HFX052", "HFX053", "HFX054", "HFX055", "HFX056",
    "HFX057", "HFX058", "HFX059(lost/found)", "HFX060", "HFX062",
    "HFX063"
  ), mean_latitude = c(
    44.40863, 44.403, 44.39144, 44.3855,
    44.36267, 44.35121, 44.34509, 44.33924, 44.33408, 44.32771, 44.32302,
    44.31668, 44.3106, 44.30479, 44.29906, 44.29311, 44.28729, 44.28173,
    43.4, 44.25865, 44.25293, 44.24714, 44.23626, 44.21905, 44.2133,
    44.20696, 44.20203, 44.19641, 44.19071, 44.18508, 44.17948, 44.17387,
    44.16814, 44.16265, 44.15686, 44.15139, 44.1, 44.13981, 44.12893,
    44.12289
  ), mean_longitude = c(
    -63.45589, -63.44875, -63.43603,
    -63.42997, -63.40261, -63.39103, -63.38422, -63.37781, -63.3713,
    -63.36478, -63.36093, -63.35154, -63.34534, -63.33867, -63.33237,
    -63.32598, -63.31992, -63.3131, -65.6, -63.28784, -63.28102,
    -63.27502, -63.26195, -63.24336, -63.23715, -63.23135, -63.2246,
    -63.21911, -63.21268, -63.20632, -63.20007, -63.19376, -63.18762,
    -63.18116, -63.17499, -63.16853, -63.3, -63.15623, -63.14374,
    -63.13765
  )), class = "data.frame", row.names = c(NA, -40L))

blueshark_ri_awo_data <-
  structure(list(
    days_detected = c(
      1.15740740740741e-05, 0.0119907407407407,
      0.0194560185185185, 0.0268055555555556, 1.15740740740741e-05,
      0.00408564814814815, 0.0284259259259259, 0.0267708333333333,
      0.0147222222222222, 0.00701388888888889, 0.0450115740740741,
      0.0911342592592593, 0.0759027777777778, 0.0404050925925926, 0.0612847222222222,
      0.0534259259259259, 0.159791666666667, 0.209270833333333, 0.408425925925926,
      0.191180555555556, 0.209421296296296, 0.389039351851852, 0.572581018518519,
      0.262407407407407, 1.3865625, 0.0394097222222222, 0.0647106481481481,
      0.0103472222222222, 0.0173263888888889, 0.039837962962963, 0.0577199074074074,
      0.0722106481481481, 0.019212962962963, 2.31481481481481e-05,
      0.0226157407407407, 0.00652777777777778, 0.00385416666666667,
      0.0037037037037037, 0.0180555555555556, 0.0218865740740741
    ),
    total_days = c(
      4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852, 4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852, 4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852, 4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852, 4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852, 4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852, 4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852, 4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852, 4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852, 4.69258101851852, 4.69258101851852, 4.69258101851852,
      4.69258101851852
    ), residency_index = c(
      2.46646227915913e-06,
      0.00255525492120886, 0.0041461230912665, 0.00571232663853255,
      2.46646227915913e-06, 0.000870661184543174, 0.00605763135761483,
      0.00570492725169508, 0.00313734001909042, 0.00149467614117043,
      0.00959207180364987, 0.019420923986099, 0.0161750596267256,
      0.00861041981654453, 0.0130599177681476, 0.0113851898805986,
      0.034051978226071, 0.0445961044694763, 0.0870365209069675,
      0.0407410239271506, 0.0446281684791054, 0.082905196589376,
      0.122018355412281, 0.0559196327930959, 0.295479714580985,
      0.00839830406053685, 0.0137899906027787, 0.00220501727756827,
      0.00369229403190122, 0.00848956316486574, 0.0123002473861666,
      0.0153882581596738, 0.00409432738340416, 4.93292455831827e-06,
      0.00481946729347695, 0.00139108472544575, 0.000821331938959991,
      0.000789267929330923, 0.00384768115548825, 0.00466408016988992
    ), location = c(
      "HFX013", "HFX014", "HFX016", "HFX017", "HFX021",
      "HFX023", "HFX024", "HFX025", "HFX026", "HFX027", "HFX028",
      "HFX029", "HFX030", "HFX031", "HFX032", "HFX033", "HFX034",
      "HFX035", "HFX038(lost/found)", "HFX039", "HFX040", "HFX041",
      "HFX043", "HFX046", "HFX047", "HFX048", "HFX049", "HFX050",
      "HFX051", "HFX052", "HFX053", "HFX054", "HFX055", "HFX056",
      "HFX057", "HFX058", "HFX059(lost/found)", "HFX060", "HFX062",
      "HFX063"
    ), mean_latitude = c(
      44.40863, 44.403, 44.39144,
      44.3855, 44.36267, 44.35121, 44.34509, 44.33924, 44.33408,
      44.32771, 44.32302, 44.31668, 44.3106, 44.30479, 44.29906,
      44.29311, 44.28729, 44.28173, 43.4, 44.25865, 44.25293, 44.24714,
      44.23626, 44.21905, 44.2133, 44.20696, 44.20203, 44.19641,
      44.19071, 44.18508, 44.17948, 44.17387, 44.16814, 44.16265,
      44.15686, 44.15139, 44.1, 44.13981, 44.12893, 44.12289
    ),
    mean_longitude = c(
      -63.45589, -63.44875, -63.43603, -63.42997,
      -63.40261, -63.39103, -63.38422, -63.37781, -63.3713, -63.36478,
      -63.36093, -63.35154, -63.34534, -63.33867, -63.33237, -63.32598,
      -63.31992, -63.3131, -65.6, -63.28784, -63.28102, -63.27502,
      -63.26195, -63.24336, -63.23715, -63.23135, -63.2246, -63.21911,
      -63.21268, -63.20632, -63.20007, -63.19376, -63.18762, -63.18116,
      -63.17499, -63.16853, -63.3, -63.15623, -63.14374, -63.13765
    )
  ), class = "data.frame", row.names = c(NA, -40L))

blueshark_ri_ano_data <-
  structure(list(days_detected = c(
    0, 0.0119907407407407, 0.0194328703703704,
    0.0267708333333333, 0, 0.00405092592592593, 0.0283449074074074,
    0.0266782407407407, 0.0146759259259259, 0.00700231481481481,
    0.0447916666666667, 0.0909027777777778, 0.0752199074074074, 0.0400578703703704,
    0.0607291666666667, 0.0529050925925926, 0.159155092592593, 0.208831018518519,
    0.406840277777778, 0.180983796296296, 0.20625, 0.388391203703704,
    0.565081018518519, 0.262349537037037, 1.3865162037037, 0.0392013888888889,
    0.0642708333333333, 0.0100115740740741, 0.0171990740740741, 0.0394097222222222,
    0.0570949074074074, 0.0702546296296296, 0.0190046296296296, 0,
    0.0225347222222222, 0.00640046296296296, 0.00375, 0.0037037037037037,
    0.0180324074074074, 0.0218518518518519
  ), total_days = c(
    4.046875,
    4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875,
    4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875,
    4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875,
    4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875,
    4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875, 4.046875,
    4.046875, 4.046875, 4.046875, 4.046875
  ), residency_index = c(
    0,
    0.00296296296296296, 0.0048019448019448, 0.00661518661518662,
    0, 0.001001001001001, 0.007004147004147, 0.00659230659230659,
    0.00362648362648363, 0.00173030173030173, 0.0110682110682111,
    0.0224624624624625, 0.0185871585871586, 0.0098984698984699, 0.015006435006435,
    0.0130730730730731, 0.0393278993278993, 0.0516030316030316, 0.100531960531961,
    0.0447218647218647, 0.050965250965251, 0.095973115973116, 0.13963391963392,
    0.0648276848276848, 0.342614042614043, 0.00968682968682969, 0.0158815958815959,
    0.00247390247390247, 0.00424996424996425, 0.00973830973830974,
    0.0141083941083941, 0.0173602173602174, 0.0046961246961247, 0,
    0.00556842556842557, 0.00158158158158158, 0.000926640926640927,
    0.000915200915200915, 0.00445588445588446, 0.0053996853996854
  ), location = c(
    "HFX013", "HFX014", "HFX016", "HFX017", "HFX021",
    "HFX023", "HFX024", "HFX025", "HFX026", "HFX027", "HFX028", "HFX029",
    "HFX030", "HFX031", "HFX032", "HFX033", "HFX034", "HFX035", "HFX038(lost/found)",
    "HFX039", "HFX040", "HFX041", "HFX043", "HFX046", "HFX047", "HFX048",
    "HFX049", "HFX050", "HFX051", "HFX052", "HFX053", "HFX054", "HFX055",
    "HFX056", "HFX057", "HFX058", "HFX059(lost/found)", "HFX060",
    "HFX062", "HFX063"
  ), mean_latitude = c(
    44.40863, 44.403, 44.39144,
    44.3855, 44.36267, 44.35121, 44.34509, 44.33924, 44.33408, 44.32771,
    44.32302, 44.31668, 44.3106, 44.30479, 44.29906, 44.29311, 44.28729,
    44.28173, 43.4, 44.25865, 44.25293, 44.24714, 44.23626, 44.21905,
    44.2133, 44.20696, 44.20203, 44.19641, 44.19071, 44.18508, 44.17948,
    44.17387, 44.16814, 44.16265, 44.15686, 44.15139, 44.1, 44.13981,
    44.12893, 44.12289
  ), mean_longitude = c(
    -63.45589, -63.44875,
    -63.43603, -63.42997, -63.40261, -63.39103, -63.38422, -63.37781,
    -63.3713, -63.36478, -63.36093, -63.35154, -63.34534, -63.33867,
    -63.33237, -63.32598, -63.31992, -63.3131, -65.6, -63.28784,
    -63.28102, -63.27502, -63.26195, -63.24336, -63.23715, -63.23135,
    -63.2246, -63.21911, -63.21268, -63.20632, -63.20007, -63.19376,
    -63.18762, -63.18116, -63.17499, -63.16853, -63.3, -63.15623,
    -63.14374, -63.13765
  )), class = "data.frame", row.names = c(
    NA,
    -40L
  ))

# note that these are just checking RI values after sort for now since
# structure of object returned by residence_index recently changed
# group_col = NULL was added to each call above for same reason

# Test using testthat library
test_that("RI for Kessel method gives exepected result on blue sharks", {
  # Check if expected and actual results are the same
  expect_equal(
    sort(rik_data$residency_index),
    sort(blueshark_ri_kessel_data$residency_index)
  )
})


# Test using testthat library
test_that("RI for timedelta method gives exepected result on blue sharks", {
  # Check if expected and actual results are the same
  expect_equal(
    sort(rit_data$residency_index),
    sort(blueshark_ri_td_data$residency_index)
  )
})

# Test using testthat library
test_that("RI for Aggregate With Overlap method gives exepected result on blue sharks", {
  # Check if expected and actual results are the same
  expect_equal(
    sort(riawo_data$residency_index),
    sort(blueshark_ri_awo_data$residency_index)
  )
})

# Test using testthat library
test_that("RI for Aggregate No Overlap method gives exepected result on blue sharks", {
  # Check if expected and actual results are the same
  expect_equal(
    sort(riano_data$residency_index),
    sort(blueshark_ri_ano_data$residency_index)
  )
})
